<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ваша галерея</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #f9f9f9;
    }

    .notice-bar {
      background-color: #201c1c;
      color: #999;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    .notice-bar strong {
      color: white;
      font-weight: 500;
    }

    .topbar {
      height: 45px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 35px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .topbar.fixed {
      position: fixed;
      top: 30px;
      left: 0;
      width: 100%;
      z-index: 999;
      display: none;
    }

    .topbar.static {
      position: relative;
      z-index: 1;
    }

    .topbar .left {
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }

    .topbar .right img {
      height: 25px;
      cursor: pointer;
    }

    .highlight-box {
      position: relative;
      width: 100%;
      height: 100vh;
      max-height: 1080px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .highlight-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(60%);
    }

    .overlay-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
    }

    .overlay-text h1 {
      font-size: 32px;
      margin: 0;
    }

    .overlay-text p {
      font-size: 16px;
      margin: 10px 0 0;
    }

    #photo-container {
      column-count: 4;
      column-gap: 12px;
      padding: 10px;
    }

    .photo-box {
      break-inside: avoid;
      margin-bottom: 12px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .photo-box img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
      cursor: pointer;
    }

    .download-button {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      text-decoration: none;
    }

    .download-button img {
      width: 16px;
      height: 16px;
      filter: invert(1);
    }

    .photo-box:hover .download-button {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .highlight-box {
        height: 60vh;
        max-height: none;
      }

      .overlay-text h1 {
        font-size: 24px;
      }

      .overlay-text p {
        font-size: 14px;
      }

      #photo-container {
        column-count: 2;
      }

      .topbar {
        padding: 0 16px;
      }

      .topbar .left {
        font-size: 14px;
      }

      .topbar .right img {
        height: 22px;
      }

      .notice-bar {
        font-size: 12px;
      }
    }

    /* Lightbox styles */
    #lightbox {
      position: fixed;
      z-index: 2000;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
    }

    .lightbox-backdrop {
      background: rgba(0, 0, 0, 0.85);
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
    }

    .lightbox-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lightbox-content img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 10px;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 32px;
      color: white;
      background: none;
      border: none;
      cursor: pointer;
    }

    .lightbox-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      border: none;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
    }

    .lightbox-arrow.left {
      left: 20px;
    }

    .lightbox-arrow.right {
      right: 20px;
    }

    .lightbox-arrow img {
      width: 24px;
      height: 24px;
      filter: invert(1);
    }
  </style>
</head>
<body>

  <div class="notice-bar">Фотографии доступны до <strong>01.09.2025</strong></div>

  <div class="highlight-box">
    <img id="cover-image" src="" alt="Обложка" />
    <div class="overlay-text">
      <h1 id="session-title">...</h1>
      <p id="session-date">...</p>
    </div>
  </div>

  <div class="topbar fixed" id="fixedTopbar">
    <div class="left">Kovalev Nazar</div>
    <div class="right"><img id="download-all-btn-fixed" src="img/download.svg" alt="Скачать" /></div>
  </div>

  <div class="topbar static" id="staticTopbar">
    <div class="left">Kovalev Nazar</div>
    <div class="right"><img id="download-all-btn-static" src="img/download.svg" alt="Скачать" /></div>
  </div>

  <div id="photo-container"></div>

  <!-- Lightbox -->
  <div id="lightbox">
    <div class="lightbox-backdrop" id="lightboxBackdrop"></div>
    <div class="lightbox-content">
      <img id="lightboxImage" src="" alt="Фото" />
      <button class="lightbox-close" id="lightboxClose">×</button>
      <button class="lightbox-arrow left" id="prevBtn"><img src="img/left.svg" alt="Назад"></button>
      <button class="lightbox-arrow right" id="nextBtn"><img src="img/right.svg" alt="Вперёд"></button>
    </div>
  </div>

  <script>
    let allPhotoUrls = [];
    let currentIndex = 0;

    function showLightbox(index) {
      if (!allPhotoUrls[index]) return;
      currentIndex = index;
      document.getElementById("lightboxImage").src = allPhotoUrls[index];
      document.getElementById("lightbox").style.display = "block";
    }

    function closeLightbox() {
      document.getElementById("lightbox").style.display = "none";
    }

    function nextImage() {
      currentIndex = (currentIndex + 1) % allPhotoUrls.length;
      showLightbox(currentIndex);
    }

    function prevImage() {
      currentIndex = (currentIndex - 1 + allPhotoUrls.length) % allPhotoUrls.length;
      showLightbox(currentIndex);
    }

    async function downloadAllPhotos() {
      if (allPhotoUrls.length === 0) {
        alert("Фотографии ещё не загружены.");
        return;
      }

      const zip = new JSZip();
      const promises = allPhotoUrls.map(async (url, index) => {
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          const contentType = response.headers.get("Content-Type");
          const ext = contentType.includes("jpeg") ? "jpg" : contentType.includes("png") ? "png" : "webp";
          zip.file(`photo_${String(index + 1).padStart(3, '0')}.${ext}`, blob);
        } catch (e) {
          console.error(`Ошибка при загрузке ${url}`, e);
        }
      });

      await Promise.all(promises);
      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "gallery.zip");
    }

    window.addEventListener('load', () => {
      const code = new URLSearchParams(window.location.search).get("code");
      const container = document.getElementById("photo-container");

      if (!code) return container.innerHTML = "<p>Код доступа не указан.</p>";

      fetch(`/api/photos/${code}`)
        .then(res => res.json())
        .then(data => {
          if (!data.success) return container.innerHTML = "<p>Фотографии не найдены.</p>";

          document.getElementById("cover-image").src = data.cover || "";
          document.getElementById("session-title").textContent = data.title || "Фотосессия";
          document.getElementById("session-date").textContent = data.date || "";
          allPhotoUrls = data.urls;

          data.urls.forEach((url, index) => {
            const box = document.createElement("div");
            box.className = "photo-box";

            const img = document.createElement("img");
            img.src = url;
            img.alt = "Фото";
            img.addEventListener("click", () => showLightbox(index));

            const download = document.createElement("a");
            download.href = url;
            download.download = "";
            download.className = "download-button";
            const icon = document.createElement("img");
            icon.src = "img/download.svg";
            icon.alt = "Скачать";
            download.appendChild(icon);

            box.appendChild(img);
            box.appendChild(download);
            container.appendChild(box);
          });
        })
        .catch(err => {
          console.error(err);
          container.innerHTML = "<p>Ошибка при загрузке фотографий.</p>";
        });

      const fixedTopbar = document.getElementById('fixedTopbar');
      const staticTopbar = document.getElementById('staticTopbar');
      const sentinel = document.createElement('div');
      sentinel.style.height = '1px';
      staticTopbar.before(sentinel);

      let observerStarted = false;
      window.addEventListener('scroll', () => {
        if (!observerStarted && window.scrollY >= 300) {
          observerStarted = true;
          const observer = new IntersectionObserver(([entry]) => {
            fixedTopbar.style.display = entry.isIntersecting ? 'none' : 'flex';
          }, { threshold: 0, rootMargin: "-30px 0px 0px 0px" });
          observer.observe(sentinel);
        }
      });

      document.getElementById('download-all-btn-static').addEventListener('click', downloadAllPhotos);
      document.getElementById('download-all-btn-fixed').addEventListener('click', downloadAllPhotos);

      document.getElementById("lightboxClose").addEventListener("click", closeLightbox);
      document.getElementById("lightboxBackdrop").addEventListener("click", closeLightbox);
      document.getElementById("nextBtn").addEventListener("click", nextImage);
      document.getElementById("prevBtn").addEventListener("click", prevImage);
      document.addEventListener("keydown", e => {
        if (document.getElementById("lightbox").style.display === "block") {
          if (e.key === "ArrowRight") nextImage();
          if (e.key === "ArrowLeft") prevImage();
          if (e.key === "Escape") closeLightbox();
        }
      });
    });
  </script>
</body>
</html>
