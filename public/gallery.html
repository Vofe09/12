<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–í–∞—à–∞ –≥–∞–ª–µ—Ä–µ—è</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #f9f9f9;
    }

    .notice-bar {
      background-color: #201c1c;
      color: #999;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    .notice-bar strong {
      color: white;
      font-weight: 500;
    }

    .topbar {
      height: 45px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 35px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .topbar.fixed {
      position: fixed;
      top: 30px;
      left: 0;
      width: 100%;
      z-index: 999;
      display: none;
    }

    .topbar.static {
      position: relative;
      z-index: 1;
    }

    .topbar .left {
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }

    .topbar .right img {
      height: 25px;
      cursor: pointer;
    }

    .highlight-box {
      position: relative;
      width: 100%;
      height: 100vh;
      max-height: 1080px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .highlight-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(60%);
    }

    .overlay-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
    }

    .overlay-text h1 {
      font-size: 32px;
      margin: 0;
    }

    .overlay-text p {
      font-size: 16px;
      margin: 10px 0 0;
    }

    #photo-container {
      column-count: 4;
      column-gap: 12px;
      padding: 0 35px;
    }

    .photo-box {
      break-inside: avoid;
      margin-bottom: 12px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .photo-box img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
      cursor: zoom-in;
    }

    .download-button {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      text-decoration: none;
    }

    .download-button img {
      width: 16px;
      height: 16px;
      filter: invert(1);
    }

    .photo-box:hover .download-button {
      opacity: 1;
    }

      .lightbox-download {
      display: none;
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.15);
      padding: 10px;
      border-radius: 50%;
      z-index: 10;
    }

    .lightbox-download img {
      width: 24px;
      height: 24px;
      filter: invert(1);
    }

      .hint-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      pointer-events: none;
    }

    .hint-spotlight {
      position: absolute;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: transparent;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.6);
      pointer-events: none;
    }

    .hint-text {
      position: absolute;
      color: white;
      font-size: 16px;
      top: calc(50% + 80px);
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      max-width: 300px;
      font-weight: 500;
      pointer-events: none;
}


    @media (max-width: 768px) {
      .lightbox-download {
        display: block;
      }
    }


    /* üì± –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */
    @media (max-width: 768px) {
      .highlight-box {
        height: 60vh;
        max-height: none;
      }

      .overlay-text h1 {
        font-size: 24px;
      }

      .overlay-text p {
        font-size: 14px;
      }

      #photo-container {
        column-count: 2;
      }

      .topbar {
        padding: 0 16px;
      }

      .topbar .left {
        font-size: 14px;
      }

      .topbar .right img {
        height: 25px;
        vertical-align: middle;
        cursor: pointer;
      }

      .notice-bar {
        font-size: 12px;
      }
    }


    /* üåå Lightbox */
    #lightbox {
      position: fixed;
      z-index: 2000;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
    }

    .lightbox-backdrop {
      background: rgba(0, 0, 0, 0.85);
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
    }

    .lightbox-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lightbox-content img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 10px;
      transition: transform 0.2s ease;
      cursor: zoom-in;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 32px;
      color: white;
      background: none;
      border: none;
      cursor: pointer;
    }

    .lightbox-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      border: none;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
    }

    .lightbox-arrow.left {
      left: 20px;
    }

    .lightbox-arrow.right {
      right: 20px;
    }

    .lightbox-arrow img {
      width: 24px;
      height: 24px;
      filter: invert(1);
    }

    @media (max-width: 768px) {
      .lightbox-content {
        top: 0;
        left: 0;
        transform: none;
        width: 100vw;
        height: 100vh;
        max-width: none;
        max-height: none;
        border-radius: 0;
      }

      .lightbox-content img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 0;
      }
    }
  </style>
</head>
<body>

  <div class="notice-bar">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–æ <strong>01.09.2025</strong></div>

  <div class="highlight-box">
    <img id="cover-image" src="" alt="–û–±–ª–æ–∂–∫–∞" />
    <div class="overlay-text">
      <h1 id="session-title">...</h1>
      <p id="session-date">...</p>
    </div>
  </div>

  <div class="topbar fixed" id="fixedTopbar">
    <div class="left">Kovalev Nazar</div>
    <div class="right"><img id="download-all-btn-fixed" src="img/download.svg" alt="–°–∫–∞—á–∞—Ç—å" /></div>
  </div>

  <div class="topbar static" id="staticTopbar">
    <div class="left">Kovalev Nazar</div>
    <div class="right"><img id="download-all-btn-static" src="img/download.svg" alt="–°–∫–∞—á–∞—Ç—å" /></div>
  </div>

  <div id="photo-container"></div>

  <!-- Lightbox -->
  <div id="lightbox">
    <div class="lightbox-backdrop" id="lightboxBackdrop"></div>
    <div class="lightbox-content">
      <img id="lightboxImage" src="" alt="–§–æ—Ç–æ" />
      <button class="lightbox-close" id="lightboxClose">√ó</button>
      <button class="lightbox-arrow left" id="prevBtn"><img src="img/left.svg" alt="–ù–∞–∑–∞–¥"></button>
      <button class="lightbox-arrow right" id="nextBtn"><img src="img/right.svg" alt="–í–ø–µ—Ä—ë–¥"></button>
      <a id="lightboxDownload" class="lightbox-download" download>
        <img src="img/download.svg" alt="–°–∫–∞—á–∞—Ç—å">
      </a>
    </div>
  </div>

  <div id="downloadHintOverlay" class="hint-overlay">
    <div class="hint-spotlight"></div>
    <div class="hint-text">–°–∫–∞—á–∞–π—Ç–µ –≤—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ–¥–Ω–∏–º –Ω–∞–∂–∞—Ç–∏–µ–º</div>
  </div>


  <script>
    let allPhotoUrls = [];
    let currentIndex = 0;
    let zoomed = false;

    async function downloadAllPhotos() {
      if (allPhotoUrls.length === 0) {
        alert("–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
        return;
      }

      const zip = new JSZip();
      const promises = allPhotoUrls.map(async (url, index) => {
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          const contentType = response.headers.get("Content-Type");
          let ext = contentType.includes("jpeg") ? "jpg" :
                    contentType.includes("png") ? "png" :
                    contentType.includes("webp") ? "webp" : "jpg";
          const fileName = `photo_${String(index + 1).padStart(3, '0')}.${ext}`;
          zip.file(fileName, blob);
        } catch (e) {
          console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ${url}`, e);
        }
      });

      await Promise.all(promises);
      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "gallery.zip");
    }

    function showLightbox(index) {
      if (!allPhotoUrls[index]) return;
      currentIndex = index;
      zoomed = false;
      document.getElementById("lightboxDownload").href = allPhotoUrls[index];
      const lightboxImage = document.getElementById("lightboxImage");
      lightboxImage.src = allPhotoUrls[index];
      lightboxImage.style.transform = "scale(1)";
      document.getElementById("lightbox").style.display = "block";
    }

    function closeLightbox() {
      document.getElementById("lightbox").style.display = "none";
    }

    function nextImage() {
      currentIndex = (currentIndex + 1) % allPhotoUrls.length;
      showLightbox(currentIndex);
    }

    function prevImage() {
      currentIndex = (currentIndex - 1 + allPhotoUrls.length) % allPhotoUrls.length;
      showLightbox(currentIndex);
    }

    window.addEventListener('load', () => {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      const container = document.getElementById("photo-container");

      if (!code) {
        container.innerHTML = "<p>–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞ –Ω–µ —É–∫–∞–∑–∞–Ω.</p>";
        return;
      }

      fetch(`/api/photos/${code}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById("cover-image").src = data.cover || "";
            document.getElementById("session-title").textContent = data.title || "–§–æ—Ç–æ—Å–µ—Å—Å–∏—è";
            document.getElementById("session-date").textContent = data.date || "";
            allPhotoUrls = data.urls;

            data.urls.forEach((url, index) => {
              const box = document.createElement("div");
              box.className = "photo-box";

              const img = document.createElement("img");
              img.src = url;
              img.alt = "–§–æ—Ç–æ";
              img.addEventListener("click", () => showLightbox(index));

              const download = document.createElement("a");
              download.href = url;
              download.download = "";
              download.className = "download-button";

              const icon = document.createElement("img");
              icon.src = "img/download.svg";
              icon.alt = "–°–∫–∞—á–∞—Ç—å";
              download.appendChild(icon);

              box.appendChild(img);
              box.appendChild(download);
              container.appendChild(box);
            });
          } else {
            container.innerHTML = "<p>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–¥–∞.</p>";
          }
        });

      const sentinel = document.createElement('div');
      sentinel.style.height = '1px';
      document.getElementById('staticTopbar').before(sentinel);
      let observerStarted = false;

      window.addEventListener('scroll', () => {
        if (!observerStarted && window.scrollY >= 300) {
          observerStarted = true;
          const observer = new IntersectionObserver(([entry]) => {
            document.getElementById('fixedTopbar').style.display = entry.isIntersecting ? 'none' : 'flex';
          }, { rootMargin: "-30px 0px 0px 0px" });
          observer.observe(sentinel);
        }
      });

      document.getElementById('download-all-btn-static').addEventListener('click', downloadAllPhotos);
      document.getElementById('download-all-btn-fixed').addEventListener('click', downloadAllPhotos);
      document.getElementById("lightboxClose").addEventListener("click", closeLightbox);
      document.getElementById("lightboxBackdrop").addEventListener("click", closeLightbox);
      document.getElementById("nextBtn").addEventListener("click", nextImage);
      document.getElementById("prevBtn").addEventListener("click", prevImage);
      document.addEventListener("keydown", e => {
        if (document.getElementById("lightbox").style.display === "block") {
          if (e.key === "ArrowRight") nextImage();
          if (e.key === "ArrowLeft") prevImage();
          if (e.key === "Escape") closeLightbox();
        }
      });

      document.getElementById("lightboxImage").addEventListener("click", () => {
        const img = document.getElementById("lightboxImage");
        zoomed = !zoomed;
        img.style.transform = zoomed ? "scale(2.5)" : "scale(1)";
        img.style.cursor = zoomed ? "zoom-out" : "zoom-in";
      });
    });

    const lightboxImage = document.getElementById("lightboxImage");

    lightboxImage.addEventListener("mousemove", (e) => {
      if (window.innerWidth <= 768) return; // –¢–æ–ª—å–∫–æ –Ω–∞ –ü–ö
      const rect = lightboxImage.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;
      lightboxImage.style.transformOrigin = `${x}% ${y}%`;
      if (zoomed) {
        lightboxImage.style.transform = "scale(2.5)";
      }
    });

    lightboxImage.addEventListener("mouseleave", () => {
      if (window.innerWidth <= 768) return;
      if (zoomed) {
        lightboxImage.style.transform = "scale(2.5)";
      } else {
        lightboxImage.style.transform = "scale(1)";
      }
    });

    let hintShown = false;

    window.addEventListener('scroll', () => {
      if (!hintShown && window.scrollY > 500) {
        hintShown = true;

        const overlay = document.getElementById('downloadHintOverlay');
        const spotlight = overlay.querySelector('.hint-spotlight');

        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫—Ä—É–≥ –Ω–∞ –∫–Ω–æ–ø–∫–µ
        const targetBtn = document.getElementById('download-all-btn-fixed');
        const rect = targetBtn.getBoundingClientRect();

        spotlight.style.top = `${rect.top + rect.height / 2 - 60}px`;
        spotlight.style.left = `${rect.left + rect.width / 2 - 60}px`;

        overlay.style.display = 'block';

        // –£–±–∏—Ä–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ
        overlay.addEventListener('click', () => {
          overlay.style.display = 'none';
        });
      }
    });

  </script>
</body>
</html>
